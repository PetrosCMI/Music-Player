<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player v1.8</title>
    <style>
        :root {
            --accent: #ffffff;
            --bg: #000000;
            --item-bg: #1a1a1a;
            --text: #ffffff;
            --radius: 50px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .player-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }

        .header { text-align: center; padding: 2px 0; }
        .version { font-size: 0.7rem; opacity: 0.4; }

        /* Track Info */
        .now-playing { text-align: center; padding: 5px 0; }
        #trackName { 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin: 0;
            line-height: 1.1;
            word-break: break-word;
        }

        /* Progress Bar */
        .progress-box { padding: 5px 0; }
        #seekSlider { 
            width: 100%; 
            accent-color: var(--accent); 
            height: 15px; /* Thicker for visibility */
            margin: 0; 
        }
        .time-info { 
            display: flex; 
            justify-content: space-between; 
            font-size: 1.2rem; 
            font-family: monospace;
            margin-top: 2px;
        }

        /* Main Playback Controls */
        .controls-main { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .btn-round {
            background: var(--item-bg);
            border: 2px solid #333;
            color: white;
            padding: 10px 20px;
            font-size: 1.8rem;
            border-radius: var(--radius);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .play-pause-btn { 
            background: var(--accent); 
            color: var(--bg);
            padding: 12px 35px;
            font-size: 2.2rem;
            border: none;
        }

        /* Speed Controls - High Visibility */
        .speed-section {
            background: #111;
            border: 2px solid #333;
            border-radius: 25px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .speed-label-top { 
            display: block; 
            text-align: center; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            margin-bottom: 8px;
            letter-spacing: 1px;
            opacity: 0.6;
        }
        .speed-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #speedSlider { 
            flex-grow: 1; 
            accent-color: var(--accent); 
            height: 10px;
        }
        .speed-val-box { 
            font-size: 1.4rem; 
            font-weight: bold; 
            min-width: 60px; 
            text-align: center; 
            background: #222;
            border-radius: 10px;
            padding: 4px;
        }
        .speed-adj-btn { 
            background: var(--accent); 
            color: var(--bg); 
            border: none; 
            padding: 8px 18px; 
            font-size: 1.2rem; 
            font-weight: 900;
            border-radius: 15px;
            cursor: pointer;
        }

        /* Management Buttons (Add/Clear/Loop) */
        .mgmt-row { 
            display: flex;
            justify-content: center;
            gap: 6px; 
            margin-bottom: 10px;
        }
        .action-btn { 
            background: var(--item-bg); 
            padding: 10px 16px; 
            border-radius: var(--radius);
            font-weight: bold; 
            font-size: 1.1rem; 
            border: 2px solid #333;
            color: white;
            flex: 1;
            text-align: center;
        }
        .btn-loop.active { 
            background: var(--accent); 
            color: var(--bg);
            border-color: var(--accent);
        }

        /* Playlist - Uses remaining space */
        .playlist { 
            flex-grow: 1;
            overflow-y: auto; 
            background: #050505;
            border-radius: 15px;
            border: 2px solid #222;
        }
        .track-item { 
            padding: 15px; 
            font-size: 1.5rem;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
        }
        .track-item.active { 
            background: var(--accent); 
            color: var(--bg); 
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="player-container">
    <div class="header">
        <div class="version">AUDIO PLAYER v1.8</div>
    </div>

    <div class="now-playing">
        <p id="trackName">NO TRACK</p>
    </div>

    <div class="progress-box">
        <input type="range" id="seekSlider" value="0" min="0" step="0.1">
        <div class="time-info">
            <span id="curTime">0:00</span>
            <span id="durTime">0:00</span>
        </div>
    </div>

    <div class="controls-main">
        <button class="btn-round" onclick="prevTrack()">⏮</button>
        <button class="btn-round play-pause-btn" id="playBtn" onclick="togglePlay()">▶</button>
        <button class="btn-round" onclick="skipForward()">⏭</button>
    </div>

    <div class="speed-section">
        <span class="speed-label-top">Playback Speed</span>
        <div class="speed-controls">
            <button class="speed-adj-btn" onclick="adjSpeed(-0.1)">-</button>
            <input type="range" id="speedSlider" min="0.5" max="2.5" step="0.1" value="1.0">
            <button class="speed-adj-btn" onclick="adjSpeed(0.1)">+</button>
            <div class="speed-val-box"><span id="speedVal">1.0</span>x</div>
        </div>
    </div>

    <div class="mgmt-row">
        <button class="action-btn" onclick="addTracks()">+ ADD</button>
        <button class="action-btn" onclick="clearAll()">CLEAR</button>
        <button class="action-btn btn-loop" id="loopBtn" onclick="toggleLoop()">LOOP: OFF</button>
    </div>

    <div class="playlist" id="playlist"></div>
</div>

<audio id="player"></audio>

<script>
    const audio = document.getElementById('player');
    const playBtn = document.getElementById('playBtn');
    const seekSlider = document.getElementById('seekSlider');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const playlistElem = document.getElementById('playlist');
    const trackNameDisp = document.getElementById('trackName');
    const loopBtn = document.getElementById('loopBtn');

    let library = []; 
    let currentIndex = 0;
    let loopMode = 0; 

    // Initialize DB
    let db;
    const request = indexedDB.open("PlayerMetaDB", 1);
    request.onupgradeneeded = e => {
        e.target.result.createObjectStore("meta", { keyPath: "id" });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadSavedLibrary();
    };

    async function saveLibraryToDB() {
        const tx = db.transaction("meta", "readwrite");
        tx.objectStore("meta").put({ id: "library", data: library });
        localStorage.setItem('last_index', currentIndex);
        localStorage.setItem('last_pos', audio.currentTime);
        localStorage.setItem('last_loop', loopMode);
    }

    async function loadSavedLibrary() {
        const tx = db.transaction("meta", "readonly");
        const req = tx.objectStore("meta").get("library");
        req.onsuccess = () => {
            if (req.result) {
                library = req.result.data;
                renderPlaylist();
                restoreSession();
            }
        };
    }

    async function addTracks() {
        if ('showOpenFilePicker' in window) {
            try {
                const handles = await window.showOpenFilePicker({
                    multiple: true,
                    types: [{ description: 'Audio', accept: { 'audio/*': ['.mp3', '.wav', '.m4a'] } }]
                });
                for (const handle of handles) {
                    library.push({ name: handle.name, handle: handle });
                }
                renderPlaylist();
                saveLibraryToDB();
            } catch (err) {}
        }
    }

    async function playTrack(index, startTime = 0) {
        if (!library[index]) return;
        currentIndex = index;
        try {
            const handle = library[index].handle;
            if (await handle.queryPermission() !== 'granted') {
                if (await handle.requestPermission() !== 'granted') return;
            }
            const file = await handle.getFile();
            if (audio.src) URL.revokeObjectURL(audio.src);
            audio.src = URL.createObjectURL(file);
            audio.currentTime = startTime;
            trackNameDisp.innerText = library[index].name;
            audio.play();
            renderPlaylist();
            setupMediaSession();
        } catch (err) { trackNameDisp.innerText = "TAP TO RELINK"; }
    }

    function renderPlaylist() {
        playlistElem.innerHTML = '';
        library.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `track-item ${idx === currentIndex ? 'active' : ''}`;
            div.innerText = item.name;
            div.onclick = () => playTrack(idx);
            playlistElem.appendChild(div);
        });
    }

    function togglePlay() {
        if (audio.paused) audio.play();
        else audio.pause();
    }

    function skipForward() { audio.currentTime += 60; }
    function prevTrack() {
        if (audio.currentTime > 5) audio.currentTime = 0;
        else playTrack((currentIndex - 1 + library.length) % library.length);
    }

    function updateLoopUI() {
        const labels = ["LOOP: OFF", "LOOP: ONE", "LOOP: ALL"];
        loopBtn.innerText = labels[loopMode];
        loopBtn.classList.toggle('active', loopMode > 0);
    }

    function toggleLoop() {
        loopMode = (loopMode + 1) % 3;
        updateLoopUI();
        saveLibraryToDB();
    }

    function adjSpeed(delta) {
        let val = (parseFloat(audio.playbackRate) + delta).toFixed(1);
        updateSpeed(val);
    }
    speedSlider.oninput = () => updateSpeed(speedSlider.value);
    function updateSpeed(val) {
        val = Math.max(0.5, Math.min(2.5, val));
        audio.playbackRate = val;
        speedSlider.value = val;
        speedVal.innerText = val;
    }

    function clearAll() {
        if(!confirm("Clear playlist?")) return;
        library = []; audio.src = "";
        trackNameDisp.innerText = "NO TRACK";
        renderPlaylist();
        saveLibraryToDB();
    }

    function restoreSession() {
        const lastIdx = localStorage.getItem('last_index');
        const lastPos = localStorage.getItem('last_pos');
        const lastLoop = localStorage.getItem('last_loop');
        if (lastLoop !== null) { loopMode = parseInt(lastLoop); updateLoopUI(); }
        if (lastIdx !== null && library[lastIdx]) {
            currentIndex = parseInt(lastIdx);
            trackNameDisp.innerText = library[currentIndex].name;
            audio.currentTime = parseFloat(lastPos || 0);
            renderPlaylist();
        }
    }

    audio.ontimeupdate = () => {
        seekSlider.max = audio.duration || 0;
        seekSlider.value = audio.currentTime;
        document.getElementById('curTime').innerText = formatTime(audio.currentTime);
        document.getElementById('durTime').innerText = formatTime(audio.duration);
        if (Math.floor(audio.currentTime) % 5 === 0) saveLibraryToDB();
    };

    audio.onplay = () => { playBtn.innerText = "⏸"; };
    audio.onpause = () => { playBtn.innerText = "▶"; };

    audio.onended = () => {
        if (loopMode === 1) audio.play();
        else if (loopMode === 2 || currentIndex < library.length - 1) {
            playTrack((currentIndex + 1) % library.length);
        }
    };

    seekSlider.oninput = () => audio.currentTime = seekSlider.value;

    function formatTime(s) {
        if (isNaN(s)) return "0:00";
        let m = Math.floor(s/60);
        let sec = Math.floor(s%60);
        return m + ":" + (sec < 10 ? "0"+sec : sec);
    }

    function setupMediaSession() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({ title: library[currentIndex].name });
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            navigator.mediaSession.setActionHandler('nexttrack', () => skipForward());
            navigator.mediaSession.setActionHandler('previoustrack', () => prevTrack());
        }
    }
</script>
</body>
</html>
