<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player v1.2</title>
    <style>
        :root {
            --accent: #ff2d55;
            --bg: #0a0a0a;
            --card: #1c1c1e;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .player-container {
            width: 100%;
            max-width: 450px;
            background: var(--card);
            border-radius: 40px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        .header { text-align: center; margin-bottom: 20px; }
        .version { font-size: 0.7rem; opacity: 0.4; letter-spacing: 1px; }

        /* Track Info */
        .now-playing { text-align: center; margin: 30px 0; }
        #trackName { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #trackArtist { font-size: 0.9rem; opacity: 0.6; }

        /* Progress */
        .progress-box { margin: 20px 0; }
        #seekSlider { width: 100%; accent-color: var(--accent); cursor: pointer; height: 6px; border-radius: 3px; }
        .time-info { display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 8px; font-family: monospace; opacity: 0.7; }

        /* Controls */
        .controls-main { display: flex; justify-content: space-around; align-items: center; margin: 30px 0; }
        button { background: none; border: none; color: white; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.9); }
        
        .play-pause-btn { 
            width: 70px; height: 70px; background: var(--accent); 
            border-radius: 50%; font-size: 1.8rem; 
            display: flex; align-items: center; justify-content: center;
        }

        /* Speed Control */
        .speed-panel { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin-bottom: 20px; }
        .speed-label { font-size: 0.8rem; opacity: 0.6; margin-bottom: 10px; display: block; }
        .speed-controls { display: flex; align-items: center; gap: 10px; }
        #speedSlider { flex-grow: 1; accent-color: var(--accent); }
        .speed-btn { padding: 5px 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 0.8rem; }

        /* List Management */
        .playlist { max-height: 180px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; margin-bottom: 20px; }
        .track-item { padding: 12px 15px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .track-item.active { color: var(--accent); background: rgba(255,45,85,0.1); }

        .footer-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; font-weight: 600; font-size: 0.8rem; }
        .btn-loop.active { background: var(--accent); color: white; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>

<div class="player-container">
    <div class="header">
        <div class="version">AUDIO PLAYER v1.2</div>
    </div>

    <div class="now-playing">
        <div id="trackName">No File Loaded</div>
        <div id="trackArtist">Tap + to add local music</div>
    </div>

    <div class="progress-box">
        <input type="range" id="seekSlider" value="0" min="0" step="0.1">
        <div class="time-info">
            <span id="curTime">0:00</span>
            <span id="durTime">0:00</span>
        </div>
    </div>

    <div class="controls-main">
        <button onclick="prevTrack()" style="font-size: 1.5rem;">⏮</button>
        <button class="play-pause-btn" id="playBtn" onclick="togglePlay()">▶</button>
        <button onclick="skipForward()" style="font-size: 1.5rem;">⏭</button>
    </div>

    <div class="speed-panel">
        <span class="speed-label">Playback Speed: <span id="speedVal">1.0</span>x</span>
        <div class="speed-controls">
            <button class="speed-btn" onclick="adjSpeed(-0.1)">-0.1</button>
            <input type="range" id="speedSlider" min="0.5" max="2.5" step="0.1" value="1.0">
            <button class="speed-btn" onclick="adjSpeed(0.1)">+0.1</button>
        </div>
    </div>

    <div class="playlist" id="playlist"></div>

    <div class="footer-btns">
        <button class="action-btn" onclick="addTracks()">+ Add Tracks</button>
        <button class="action-btn" onclick="clearAll()">Clear List</button>
        <button class="action-btn btn-loop" id="loopBtn" onclick="toggleLoop()" style="grid-column: span 2;">Loop: Off</button>
    </div>
</div>

<audio id="player"></audio>

<script>
    const audio = document.getElementById('player');
    const playBtn = document.getElementById('playBtn');
    const seekSlider = document.getElementById('seekSlider');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const playlistElem = document.getElementById('playlist');
    const trackNameDisp = document.getElementById('trackName');

    let library = []; // Stores { name: string, handle: FileHandle }
    let currentIndex = 0;
    let loopMode = 0; // 0: None, 1: Track, 2: All

    // --- Persistence Setup (IndexedDB) ---
    // We store the "Handle" which is a pointer to the file, not the file itself.
    let db;
    const request = indexedDB.open("PlayerMetaDB", 1);
    request.onupgradeneeded = e => {
        e.target.result.createObjectStore("meta", { keyPath: "id" });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadSavedLibrary();
    };

    async function saveLibraryToDB() {
        const tx = db.transaction("meta", "readwrite");
        tx.objectStore("meta").put({ id: "library", data: library });
        localStorage.setItem('last_index', currentIndex);
        localStorage.setItem('last_pos', audio.currentTime);
    }

    async function loadSavedLibrary() {
        const tx = db.transaction("meta", "readonly");
        const req = tx.objectStore("meta").get("library");
        req.onsuccess = async () => {
            if (req.result) {
                library = req.result.data;
                renderPlaylist();
                restoreSession();
            }
        };
    }

    // --- Logic ---

    async function addTracks() {
        // Use File System Access API to get persistent handles
        if ('showOpenFilePicker' in window) {
            const handles = await window.showOpenFilePicker({
                multiple: true,
                types: [{ description: 'Audio', accept: { 'audio/*': ['.mp3', '.wav', '.ogg', '.m4a'] } }]
            });
            for (const handle of handles) {
                library.push({ name: handle.name, handle: handle });
            }
        } else {
            alert("Your browser doesn't support persistent file handles. Try Chrome or Edge.");
        }
        renderPlaylist();
        saveLibraryToDB();
    }

    async function playTrack(index, startTime = 0) {
        if (!library[index]) return;
        currentIndex = index;
        
        try {
            // Request permission if needed (security requirement)
            const handle = library[index].handle;
            const permission = await handle.queryPermission();
            if (permission !== 'granted') {
                if (await handle.requestPermission() !== 'granted') return;
            }

            const file = await handle.getFile();
            if (audio.src) URL.revokeObjectURL(audio.src);
            audio.src = URL.createObjectURL(file);
            audio.currentTime = startTime;
            trackNameDisp.innerText = library[index].name;
            audio.play();
            renderPlaylist();
            setupMediaSession();
        } catch (err) {
            console.error("File access failed", err);
            trackNameDisp.innerText = "Click track to relink file";
        }
    }

    function renderPlaylist() {
        playlistElem.innerHTML = '';
        library.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `track-item ${idx === currentIndex ? 'active' : ''}`;
            div.innerText = item.name;
            div.onclick = () => playTrack(idx);
            playlistElem.appendChild(div);
        });
    }

    function togglePlay() {
        if (audio.paused) audio.play();
        else audio.pause();
    }

    function skipForward() { audio.currentTime += 60; }

    function prevTrack() {
        if (audio.currentTime > 5) audio.currentTime = 0;
        else playTrack((currentIndex - 1 + library.length) % library.length);
    }

    function toggleLoop() {
        loopMode = (loopMode + 1) % 3;
        const labels = ["Loop: Off", "Loop: One", "Loop: All"];
        document.getElementById('loopBtn').innerText = labels[loopMode];
        document.getElementById('loopBtn').classList.toggle('active', loopMode > 0);
    }

    function adjSpeed(delta) {
        let val = (parseFloat(audio.playbackRate) + delta).toFixed(1);
        updateSpeed(val);
    }

    speedSlider.oninput = () => updateSpeed(speedSlider.value);

    function updateSpeed(val) {
        val = Math.max(0.5, Math.min(2.5, val));
        audio.playbackRate = val;
        speedSlider.value = val;
        speedVal.innerText = val;
    }

    function clearAll() {
        library = [];
        audio.src = "";
        trackNameDisp.innerText = "No File Loaded";
        renderPlaylist();
        saveLibraryToDB();
    }

    function restoreSession() {
        const lastIdx = localStorage.getItem('last_index');
        const lastPos = localStorage.getItem('last_pos');
        if (lastIdx !== null && library[lastIdx]) {
            currentIndex = parseInt(lastIdx);
            trackNameDisp.innerText = library[currentIndex].name + " (Paused)";
            // We don't autoplay on refresh (browser block), 
            // but we'll prepare the track when they hit play.
        }
    }

    // --- Audio Listeners ---

    audio.ontimeupdate = () => {
        seekSlider.max = audio.duration || 0;
        seekSlider.value = audio.currentTime;
        document.getElementById('curTime').innerText = formatTime(audio.currentTime);
        document.getElementById('durTime').innerText = formatTime(audio.duration);
        // Persist position every 5s
        if (Math.floor(audio.currentTime) % 5 === 0) saveLibraryToDB();
    };

    audio.onplay = () => { playBtn.innerText = "⏸"; navigator.mediaSession.playbackState = "playing"; };
    audio.onpause = () => { playBtn.innerText = "▶"; navigator.mediaSession.playbackState = "paused"; };

    audio.onended = () => {
        if (loopMode === 1) audio.play();
        else if (loopMode === 2 || currentIndex < library.length - 1) {
            playTrack((currentIndex + 1) % library.length);
        }
    };

    seekSlider.oninput = () => audio.currentTime = seekSlider.value;

    function formatTime(s) {
        if (isNaN(s)) return "0:00";
        let m = Math.floor(s/60);
        let sec = Math.floor(s%60);
        return m + ":" + (sec < 10 ? "0"+sec : sec);
    }

    // --- Media Session (Bluetooth) ---

    function setupMediaSession() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: library[currentIndex].name,
                artist: "Local Player",
                album: "v1.2"
            });
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            // Double click headset = nexttrack signal
            navigator.mediaSession.setActionHandler('nexttrack', () => skipForward());
            // Triple click headset = previoustrack signal
            navigator.mediaSession.setActionHandler('previoustrack', () => prevTrack());
        }
    }
</script>

</body>
</html>
