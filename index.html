<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player v1.0</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --primary: #1db954;
            --text: #ffffff;
            --text-dim: #b3b3b3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 1.5rem; text-align: center; margin-bottom: 20px; color: var(--primary); }

        /* Playlist Styles */
        #playlist {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .track-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .track-item.active { background: #333; color: var(--primary); font-weight: bold; }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        button:hover { background: #444; }
        button.active { background: var(--primary); }

        .play-btn { background: var(--primary); grid-column: span 3; font-size: 1.2rem; }

        /* Sliders */
        .slider-container { margin: 20px 0; }
        label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        .speed-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Audio Player v1.0</h1>

    <div class="file-input-wrapper">
        <button onclick="document.getElementById('fileInput').click()" style="flex: 2;">+ Add Tracks</button>
        <button onclick="clearPlaylist()" style="flex: 1; background: #600;">Clear</button>
        <input type="file" id="fileInput" class="hidden" multiple accept="audio/*">
    </div>

    <ul id="playlist">
        <li style="padding: 20px; text-align: center; color: #666;">No tracks added</li>
    </ul>

    <div class="slider-container">
        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>
        <input type="range" id="progressSlider" value="0" min="0" step="1">
    </div>

    <div class="controls-grid">
        <button onclick="prevTrack()">‚èÆ Prev (Triple Click)</button>
        <button onclick="togglePlay()" id="playBtn" class="play-btn">Play</button>
        <button onclick="skipForward()">+60s Forward</button>
        
        <button onclick="toggleLoop()" id="loopBtn">Loop: None</button>
    </div>

    <div class="slider-container">
        <label>Playback Speed: <span id="speedVal">1.0</span>x</label>
        <div class="speed-controls">
            <button onclick="adjustSpeed(-0.1)">-0.1</button>
            <input type="range" id="speedSlider" min="0.5" max="2.5" step="0.1" value="1.0">
            <button onclick="adjustSpeed(0.1)">+0.1</button>
        </div>
    </div>
</div>

<audio id="mainAudio" class="hidden"></audio>

<script>
    const audio = document.getElementById('mainAudio');
    const fileInput = document.getElementById('fileInput');
    const playlistElem = document.getElementById('playlist');
    const playBtn = document.getElementById('playBtn');
    const progressSlider = document.getElementById('progressSlider');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const loopBtn = document.getElementById('loopBtn');
    const currentTimeText = document.getElementById('currentTime');
    const durationText = document.getElementById('duration');

    let playlist = [];
    let currentIndex = 0;
    let loopMode = 0; // 0: None, 1: Loop 1, 2: Loop All

    // --- File Handling ---
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            playlist.push({
                name: file.name,
                url: URL.createObjectURL(file)
            });
        });
        renderPlaylist();
    });

    function renderPlaylist() {
        if (playlist.length === 0) {
            playlistElem.innerHTML = '<li style="padding: 20px; text-align: center; color: #666;">No tracks added</li>';
            return;
        }
        playlistElem.innerHTML = '';
        playlist.forEach((track, index) => {
            const li = document.createElement('li');
            li.className = `track-item ${index === currentIndex ? 'active' : ''}`;
            li.innerHTML = `<span>${track.name}</span>`;
            li.onclick = () => playTrack(index);
            playlistElem.appendChild(li);
        });
    }

    function clearPlaylist() {
        playlist.forEach(track => URL.revokeObjectURL(track.url));
        playlist = [];
        audio.pause();
        audio.src = "";
        renderPlaylist();
    }

    // --- Controls ---
    function togglePlay() {
        if (playlist.length === 0) return;
        if (!audio.src) playTrack(0);
        
        if (audio.paused) {
            audio.play();
        } else {
            audio.pause();
        }
    }

    function playTrack(index) {
        if (index < 0 || index >= playlist.length) return;
        currentIndex = index;
        audio.src = playlist[currentIndex].url;
        audio.play();
        renderPlaylist();
        updateMediaSession();
    }

    function skipForward() {
        audio.currentTime = Math.min(audio.duration, audio.currentTime + 60);
    }

    function prevTrack() {
        if (audio.currentTime > 3) {
            audio.currentTime = 0;
        } else {
            let next = currentIndex - 1;
            if (next < 0) next = playlist.length - 1;
            playTrack(next);
        }
    }

    function nextTrack() {
        let next = currentIndex + 1;
        if (next >= playlist.length) {
            if (loopMode === 2) next = 0; // Loop all
            else return;
        }
        playTrack(next);
    }

    function toggleLoop() {
        loopMode = (loopMode + 1) % 3;
        const modes = ["Loop: None", "Loop: 1 Track", "Loop: All"];
        loopBtn.innerText = modes[loopMode];
        loopBtn.classList.toggle('active', loopMode > 0);
    }

    // --- Speed Logic ---
    function adjustSpeed(delta) {
        let newVal = parseFloat(speedSlider.value) + delta;
        updateSpeed(newVal);
    }

    speedSlider.oninput = (e) => updateSpeed(e.target.value);

    function updateSpeed(val) {
        const clamped = Math.max(0.5, Math.min(2.5, val)).toFixed(1);
        speedSlider.value = clamped;
        speedVal.innerText = clamped;
        audio.playbackRate = clamped;
    }

    // --- Audio Events ---
    audio.onplay = () => {
        playBtn.innerText = "Pause";
        navigator.mediaSession.playbackState = "playing";
    };

    audio.onpause = () => {
        playBtn.innerText = "Play";
        navigator.mediaSession.playbackState = "paused";
    };

    audio.ontimeupdate = () => {
        progressSlider.max = audio.duration || 0;
        progressSlider.value = audio.currentTime;
        currentTimeText.innerText = formatTime(audio.currentTime);
        durationText.innerText = formatTime(audio.duration);
    };

    audio.onended = () => {
        if (loopMode === 1) {
            audio.currentTime = 0;
            audio.play();
        } else {
            nextTrack();
        }
    };

    progressSlider.oninput = (e) => {
        audio.currentTime = e.target.value;
    };

    function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // --- Media Session (Bluetooth & Background) ---
    // This is the magic that keeps the player alive when the screen is off
    function updateMediaSession() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: playlist[currentIndex].name,
                artist: "Audio Player v1.0",
                album: "Local Files"
            });

            // Headset Controls
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            
            // Double Click usually triggers 'nexttrack'
            navigator.mediaSession.setActionHandler('nexttrack', () => {
                // Per requirements: double click = skip 60s
                skipForward();
            });

            // Triple Click usually triggers 'previoustrack'
            navigator.mediaSession.setActionHandler('previoustrack', () => {
                prevTrack();
            });

            // Support for seek bar on lock screen
            navigator.mediaSession.setActionHandler('seekto', (details) => {
                audio.currentTime = details.seekTime;
            });
        }
    }
</script>

</body>
</html>
