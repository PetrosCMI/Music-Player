<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player Pro</title>
    <style>
        /* Preserving your original UI styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .player-container { background: #1a1a2e; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); padding: 32px; width: 100%; max-width: 450px; }
        .header { text-align: center; margin-bottom: 32px; }
        .header h1 { color: white; font-size: 28px; font-weight: bold; margin-bottom: 8px; }
        .track-info { background: #16213e; border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .track-title { color: white; font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .progress-container { margin-bottom: 24px; }
        .progress-bar { width: 100%; height: 8px; background: #374151; border-radius: 4px; appearance: none; cursor: pointer; outline: none; }
        .progress-bar::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; background: #8b5cf6; border-radius: 50%; }
        .controls { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 24px; }
        .control-btn { background: #374151; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        .control-btn.large { width: 64px; height: 64px; background: #8b5cf6; }
        .control-btn.small { width: 48px; height: 48px; }
        .playlist { margin-top: 24px; max-height: 200px; overflow-y: auto; background: #16213e; border-radius: 12px; padding: 16px; color: #d1d5db; }
        .playlist-item { padding: 8px; border-radius: 6px; cursor: pointer; }
        .playlist-item.active { background: #8b5cf6; color: white; }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="header"><h1>Music Player</h1><p id="track-count">No tracks loaded</p></div>
        <div class="track-info">
            <div class="track-title" id="track-title">No track selected</div>
            <div id="track-number" style="color:#9ca3af; text-align:center; font-size:14px;">Track 0 of 0</div>
        </div>
        <div class="progress-container">
            <input type="range" class="progress-bar" id="progress-bar" min="0" max="100" value="0">
            <div style="display:flex; justify-content:space-between; color:#9ca3af; font-size:14px; margin-top:8px;">
                <span id="current-time">0:00</span><span id="duration">0:00</span>
            </div>
        </div>
        <div class="controls">
            <button class="control-btn small" id="loop-btn">Loop</button>
            <button class="control-btn large" id="play-pause-btn" disabled>Play/Pause</button>
            <button class="control-btn small" id="skip-btn" disabled>+60s</button>
        </div>
        <input type="file" id="file-input" multiple accept="audio/*" style="display:none;">
        <button id="select-btn" style="width:100%; padding:12px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer;">Add Songs</button>
        <div class="playlist" id="playlist-container" style="display:none;"><h3>Playlist</h3><div id="playlist"></div></div>
    </div>
    <audio id="audio-player"></audio>

    <script>
        const audio = document.getElementById('audio-player');
        const fileInput = document.getElementById('file-input');
        const selectBtn = document.getElementById('select-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const progressBar = document.getElementById('progress-bar');
        
        let audioFiles = [];
        let currentTrackIndex = 0;

        // Persist songs in IndexedDB to prevent "cold" resume failures
        const dbName = "MusicDB";
        let db;
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
        request.onsuccess = e => { db = e.target.result; refreshPlaylist(); };

        function refreshPlaylist() {
            const transaction = db.transaction(["songs"], "readonly");
            const store = transaction.objectStore("songs");
            store.getAll().onsuccess = (e) => {
                audioFiles = e.target.result;
                if (audioFiles.length > 0) {
                    document.getElementById('playlist-container').style.display = 'block';
                    loadTrack(0, false);
                }
                updateUI();
            };
        }

        function loadTrack(index, play = true) {
            if (!audioFiles[index]) return;
            currentTrackIndex = index;
            if (audio.src) URL.revokeObjectURL(audio.src);
            audio.src = URL.createObjectURL(audioFiles[index].data);
            audio.load();
            updateMediaSession();
            if (play) audio.play();
            updateUI();
        }

        // POSITION SYNC: Essential for the browser to keep the Play command "hot"
        function syncPosition() {
            if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
                navigator.mediaSession.setPositionState({
                    duration: audio.duration || 0,
                    playbackRate: audio.playbackRate || 1,
                    position: audio.currentTime || 0
                });
            }
        }

        function updateMediaSession() {
            if ('mediaSession' in navigator && audioFiles[currentTrackIndex]) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: audioFiles[currentTrackIndex].name,
                    artist: 'Music Player Pro'
                });
                // Standard Play/Pause
                navigator.mediaSession.setActionHandler('play', () => audio.play());
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                // Double Click (Next) -> Skip 60s
                navigator.mediaSession.setActionHandler('nexttrack', () => { audio.currentTime += 60; syncPosition(); });
                // Triple Click (Prev) -> Rewind to 0
                navigator.mediaSession.setActionHandler('previoustrack', () => { audio.currentTime = 0; syncPosition(); });
            }
        }

        selectBtn.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            const transaction = db.transaction(["songs"], "readwrite");
            const store = transaction.objectStore("songs");
            files.forEach(f => store.add({ name: f.name, data: f }));
            transaction.oncomplete = () => refreshPlaylist();
        };

        playPauseBtn.onclick = () => audio.paused ? audio.play() : audio.pause();

        audio.onplay = () => {
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
            syncPosition();
        };

        audio.onpause = () => {
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
            syncPosition();
        };

        audio.ontimeupdate = () => {
            progressBar.value = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('current-time').textContent = formatTime(audio.currentTime);
            if (Math.floor(audio.currentTime) % 10 === 0) syncPosition();
        };

        function updateUI() {
            playPauseBtn.disabled = audioFiles.length === 0;
            document.getElementById('skip-btn').disabled = audioFiles.length === 0;
            document.getElementById('track-title').textContent = audioFiles[currentTrackIndex]?.name || "No track selected";
            const list = document.getElementById('playlist');
            list.innerHTML = '';
            audioFiles.forEach((f, i) => {
                const item = document.createElement('div');
                item.className = 'playlist-item' + (i === currentTrackIndex ? ' active' : '');
                item.textContent = f.name;
                item.onclick = () => loadTrack(i);
                list.appendChild(item);
            });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
