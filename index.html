<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Player v3.0</title>
    <style>
        :root { --accent: #ffffff; --bg: #000000; --item-bg: #1a1a1a; --text: #ffffff; --radius: 50px; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        .player-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 5px; }
        .version { font-size: 0.7rem; opacity: 0.4; }
        .now-playing { text-align: center; padding: 10px 0; min-height: 80px; display: flex; align-items: center; justify-content: center; }
        #trackName { font-size: 1.6rem; font-weight: 800; margin: 0; line-height: 1.2; }
        .speed-stepper { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 8px; }
        .step-btn { background: #1a1a1a; border: 1px solid #333; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }
        #speedDisplay { font-family: monospace; font-size: 1.1rem; min-width: 60px; text-align: center; color: var(--accent); }
        #seekSlider { width: 100%; accent-color: var(--accent); cursor: pointer; }
        .time-info { display: flex; justify-content: space-between; font-size: 0.9rem; font-family: monospace; }
        .controls-main { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 10px 0; }
        .btn-round { background: var(--item-bg); border: 1px solid #333; color: white; padding: 10px 20px; font-size: 1.4rem; border-radius: var(--radius); cursor: pointer; }
        .play-pause-btn { background: var(--accent); color: var(--bg); padding: 12px 40px; border: none; font-size: 1.8rem; }
        .mgmt-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .action-btn { background: var(--item-bg); padding: 10px; border-radius: 10px; border: 1px solid #333; color: white; flex: 1; cursor: pointer; font-weight: bold; }
        .playlist { flex-grow: 1; overflow-y: auto; background: #050505; border-radius: 12px; border: 1px solid #222; }
        .track-item { padding: 12px 15px; font-size: 1.1rem; border-bottom: 1px solid #111; cursor: pointer; }
        .track-item.active { background: var(--accent); color: var(--bg); font-weight: bold; }
    </style>
</head>
<body>

<div class="player-container">
    <div class="header"><div class="version">v3.0 LOCAL PRO</div></div>
    <div class="now-playing"><p id="trackName">READY</p></div>

    <div class="speed-stepper">
        <button class="step-btn" onclick="adjustSpeed(-0.1)">-</button>
        <div id="speedDisplay">1.0x</div>
        <button class="step-btn" onclick="adjustSpeed(0.1)">+</button>
    </div>

    <div class="progress-box">
        <input type="range" id="seekSlider" value="0" min="0" step="0.1">
        <div class="time-info"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>
    </div>

    <div class="controls-main">
        <button class="btn-round" onclick="prevTrack()">⏮</button>
        <button class="btn-round play-pause-btn" id="playBtn" onclick="togglePlay()">▶</button>
        <button class="btn-round" onclick="nextTrack()">⏭</button>
    </div>

    <div class="mgmt-row">
        <button class="action-btn" onclick="addLocalTracks()">+ ADD FILES</button>
        <button class="action-btn" onclick="clearAll()">CLEAR ALL</button>
    </div>

    <div class="playlist" id="playlist"></div>
</div>

<audio id="player"></audio>

<script>
    // --- CONFIG ---
    const SKIP_TIME = 60; 

    // --- ELEMENTS ---
    const audio = document.getElementById('player');
    const playBtn = document.getElementById('playBtn');
    const trackNameDisp = document.getElementById('trackName');
    const playlistElem = document.getElementById('playlist');
    const seekSlider = document.getElementById('seekSlider');
    const speedDisp = document.getElementById('speedDisplay');

    // --- STATE ---
    let library = []; 
    let currentIndex = 0;
    let currentSpeed = 1.0;

    // --- DB STORAGE ---
    let db;
    const request = indexedDB.open("LocalPlayerDB_v3", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("meta", { keyPath: "id" });
    request.onsuccess = e => { db = e.target.result; loadLibrary(); };

    function saveLibrary() {
        const tx = db.transaction("meta", "readwrite");
        tx.objectStore("meta").put({ id: "library", data: library.map(i => ({ name: i.name, handle: i.handle })) });
        localStorage.setItem('last_idx', currentIndex);
    }

    function loadLibrary() {
        const tx = db.transaction("meta", "readonly");
        tx.objectStore("meta").get("library").onsuccess = e => {
            if (e.target.result) {
                library = e.target.result.data;
                renderPlaylist();
                restoreSession();
            }
        };
    }

    function restoreSession() {
        const lastIdx = localStorage.getItem('last_idx');
        if (lastIdx !== null && library[lastIdx]) {
            currentIndex = parseInt(lastIdx);
            trackNameDisp.innerText = library[currentIndex].name;
        }
    }

    // --- LOGIC ---
    function skipForward() {
        if (audio.duration) {
            audio.currentTime = Math.min(audio.currentTime + SKIP_TIME, audio.duration);
        }
    }

    async function verifyPermission(handle) {
        if ((await handle.queryPermission()) === 'granted') return true;
        return (await handle.requestPermission()) === 'granted';
    }

    async function playTrack(idx) {
        if (!library[idx]) return;
        currentIndex = idx;
        const item = library[idx];

        try {
            if (await verifyPermission(item.handle)) {
                const file = await item.handle.getFile();
                audio.src = URL.createObjectURL(file);
                trackNameDisp.innerText = item.name;
                audio.playbackRate = currentSpeed;
                audio.play();
                renderPlaylist();
                saveLibrary();
            }
        } catch (e) { trackNameDisp.innerText = "FILE ERROR"; }
    }

    function togglePlay() {
        if (audio.paused) audio.play().catch(() => {});
        else audio.pause();
    }

    async function addLocalTracks() {
        try {
            const handles = await window.showOpenFilePicker({ 
                multiple: true, 
                types: [{ accept: {'audio/*':['.mp3','.m4a','.flac']} }] 
            });
            for (const h of handles) library.push({ name: h.name, handle: h });
            renderPlaylist(); 
            saveLibrary();
        } catch(e){}
    }

    function renderPlaylist() {
        playlistElem.innerHTML = '';
        library.forEach((s, idx) => {
            const d = document.createElement('div');
            d.className = `track-item ${idx === currentIndex ? 'active' : ''}`;
            d.innerText = s.name;
            d.onclick = () => playTrack(idx);
            playlistElem.appendChild(d);
        });
    }

    // --- HEADSET & MEDIA SESSION ---
    audio.onplay = () => {
        playBtn.innerText = "⏸";
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({ title: library[currentIndex].name });
            navigator.mediaSession.setActionHandler('play', () => audio.play());
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
            // Double Click -> Skip 60s
            navigator.mediaSession.setActionHandler('nexttrack', () => skipForward());
            // Triple Click -> Next Song
            navigator.mediaSession.setActionHandler('previoustrack', () => nextTrack());
        }
    };
    audio.onpause = () => playBtn.innerText = "▶";
    audio.onended = () => nextTrack();

    // --- UI HELPERS ---
    function adjustSpeed(delta) {
        currentSpeed = Math.min(Math.max(currentSpeed + delta, 0.5), 2.5);
        audio.playbackRate = currentSpeed;
        speedDisp.innerText = currentSpeed.toFixed(1) + "x";
    }
    function nextTrack() { playTrack((currentIndex + 1) % library.length); }
    function prevTrack() { playTrack((currentIndex - 1 + library.length) % library.length); }
    function clearAll() { library=[]; renderPlaylist(); saveLibrary(); trackNameDisp.innerText="READY"; }

    audio.ontimeupdate = () => {
        seekSlider.max = audio.duration || 0; seekSlider.value = audio.currentTime;
        document.getElementById('curTime').innerText = formatTime(audio.currentTime);
        document.getElementById('durTime').innerText = formatTime(audio.duration);
    };
    seekSlider.oninput = () => audio.currentTime = seekSlider.value;
    function formatTime(s) { let m=Math.floor(s/60),sec=Math.floor(s%60); return m+":"+(sec<10?"0"+sec:sec); }
</script>
</body>
</html>
